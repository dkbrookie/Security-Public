$outputLog = @()
$errorState = $False

$originalKeyPath = "HKCR:\ms-msdt_bak"
$newKeyName = "ms-msdt"
$newKeyPath = "HKCR:\$newKeyName"
$newValue = "URL:ms-msdt"

Try {
  New-PSDrive -PSProvider registry -Root HKEY_CLASSES_ROOT -Name HKCR -ErrorAction Stop
  $outputLog += "Successfully mounted HKCR."
} Catch {
  Write-Output "!FAILED: Was not able to mount HKCR! Not able to perform any further action! The error was: $_"
  # Not able to take any further action if this fails to mount, so just return early
  Return
}

# Don't need to rename if $originalKeyPath doesn't exist
If (Get-Item -Path $originalKeyPath -ErrorAction SilentlyContinue) {
  $outputLog += "'$originalKeyPath' exists, so renaming to '$newKeyPath'."

  Try {
    Rename-Item -Path $originalKeyPath -newName $newKeyName -ErrorAction Stop
    $outputLog += "Successfully renamed '$originalKeyPath' key to '$newKeyName'"
  } Catch {
    $outputLog += "Could not rename '$originalKeyPath' key! The error was: $_"
    $errorState = $True
  }
} Else {
  $outputLog += "$originalKeyPath did not exist so nothing to rename. This mitigation has probably already been removed."
}

Try {
  Set-Item -Path $newKeyPath -Value $newValue -ErrorAction Stop
  $outputLog += "Sucessfully set value of '$newKeyPath' key to '$newValue'"
} Catch {
  $outputLog += "Could not set '$newKeyPath' value! The error was: $_"
  $errorState = $True
}

If ($errorState) {
  $outputLog = '!WARNING: ' + $outputLog
} Else {
  $outputLog = '!SUCCESS: ' + $outputLog
}

Write-Output ($outputLog -join " ")
