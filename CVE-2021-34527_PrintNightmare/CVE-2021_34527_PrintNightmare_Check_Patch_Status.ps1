$osDeets = Get-WmiObject win32_operatingsystem
$osName = $osDeets.Caption
$osArch = $osDeets.OSArchitecture

If ($osName -like 'Microsoft Windows Server 2008*' -and $osName -notlike '*R2*') {
    $os = "2008_$osArch"
} ElseIf ($osName -like 'Microsoft Windows Server 2008 R2*') {
    $os = '2008r2'
} ElseIf ($osName -like 'Microsoft Windows Server 2012*' -and $osName -notlike '*R2*') {
    $os = '2012'
} ElseIf ($osName -like 'Microsoft Windows Server 2012 R2*') {
    $os = '2012r2'
} ElseIf ($osName -like 'Microsoft Windows Server 2016*') {
    $os = '2016'
} ElseIf ($osName -like 'Microsoft Windows Server 2019*') {
    $os = '2019'
} ElseIf ($osName -like 'Microsoft Windows 10*') {
    # get raw Windows version
    [int64]$rawVersion = [Windows.System.Profile.AnalyticsInfo,Windows.System.Profile,ContentType=WindowsRuntime].GetMember('get_VersionInfo').Invoke( $Null, $Null ).DeviceFamilyVersion

    # decode bits to version bytes
    $build = ( $rawVersion -band 0x00000000FFFF0000l ) -shr 16

    Switch ($build) {
        19043 { $os = '21H1' }
        19042 { $os = '20H2' }
        19041 { $os = '2004' }
        18363 { $os = '1909' }
        18362 { $os = '1903' }
        17763 { $os = '1809' }
        17134 { $os = '1803' }
        17134 { $os = '1803' }
        16299 { $os = '1709' }
        15063 { $os = '1703' }
        14393 { $os = '1607' }
        10586 { $os = '1511' }
        10240 { $os = '1507' }
    }

    $os += "_$osArch"
} ElseIf ($osName -like 'Microsoft Windows 8*') {
    $os = "8.1_$osArch"
} ElseIf ($osName -like 'Microsoft Windows 7*') {
    $os = "7_$osArch"
}

<# ------------------------ Hash Tables and Arrays for Days (setting up download URLs and applicable KB numbers) ------------------------------------- #>

# Also applies to 2008r2
$win7PatchKbs = @(
    'KB5004951'
)

$2008PatchKbs = @(
    'KB5004959'
)

# Also applies to 2012r2
$8PatchKbs = @(
    'KB5004958'
)

$1507PatchKbs = @(
    'KB5004950',
    'KB5004249',
    'KB5005040'
)

# Also applies to server 2016
$1607PatchKbs = @(
    'KB5004948',
    'KB5004238',
    'KB5005393',
    'KB5005043'
)

# Also applies to server 2019
$1809PatchKbs = @(
    'KB5004947',
    'KB5004244',
    'KB5005394',
    'KB5004308',
    'KB5005030'
)

$1909PatchKbs = @(
    'KB5004946',
    'KB5004245',
    'KB5004293',
    'KB5005031'
)

$2004AndNewerSsuKb = 'KB4598481'
$2004AndNewerPatchKbs = @(
    'KB5004945',
    'KB5004237',
    'KB5004296',
    'KB5005033'
)

$msDPath = 'http://download.windowsupdate.com/d/msdownload/update/software/secu'
$msCPath = 'http://download.windowsupdate.com/c/msdownload/update/software/secu'

Switch ($os) {
    '7_32-bit' {
        $installHash = @{
            ssu =              'KB5004378'
            patchKBs =         $win7PatchKbs
            patchUrl =         "$msDPath/2021/07/windows6.1-kb5004951-x86_09808f3b8a74ce862f6e21ba36617c5b9bd53a3d.msu"
            ssuUrl =           "$msDPath/2021/07/windows6.1-kb5004378-x86_7f71df13245adc8c835fccdeba92303b08e26a10.msu"
        }
    }
    '7_64-bit' {
        $installHash = @{
            ssu =              'KB5004378'
            patchKBs =         $win7PatchKbs
            patchUrl =         "$msCPath/2021/07/windows6.1-kb5004951-x64_2fcf9eaa66615884884cc1cb9f75fc96294cbf2a.msu"
            ssuUrl =           "$msDPath/2021/07/windows6.1-kb5004378-x64_e295e0dfb732d1d4712c6aa5ac72aa28a7067359.msu"
        }
    }
    '2008r2' {
        $installHash = @{
            ssu =              'KB5004378'
            patchKBs =         $win7PatchKbs
            patchUrl =         "$msCPath/2021/07/windows6.1-kb5004951-x64_2fcf9eaa66615884884cc1cb9f75fc96294cbf2a.msu"
            ssuUrl =           "$msDPath/2021/07/windows6.1-kb5004378-x64_e295e0dfb732d1d4712c6aa5ac72aa28a7067359.msu"
        }
    }
    '2008_32-bit' {
        $installHash = @{
            ssu =              'KB4580971'
            patchKBs =         $2008PatchKbs
            patchUrl =         "$msCPath/2021/07/windows6.0-kb5004959-x86_7d5c62a788b49b296de559b792a8e1cd5b3fad2d.msu"
            ssuUrl =           "$msDPath/2020/10/windows6.0-kb4580971-x86_5a4cf976c650cf9b6a0800aaf6016726f4b08c7d.msu"
        }

    }
    '2008_64-bit' {
        $installHash = @{
            ssu =              'KB4580971'
            patchKBs =         $2008PatchKbs
            patchUrl =         "$msCPath/2021/07/windows6.0-kb5004959-x64_7bfadd426a5764d3a2886afbb73f727fae5e0f67.msu"
            ssuUrl =           "$msDPath/2020/10/windows6.0-kb4580971-x64_619424830431f3fba3c6d086b5dbe3e1ddf42f1f.msu"
        }
    }
    '8.1_32-bit' {
        $installHash = @{
            ssu =              'KB5001403'
            patchKBs =         $8PatchKbs
            patchUrl =         "$msCPath/2021/07/windows8.1-kb5004958-x86_ee2308010d7605cad53e19a1bc762d85d044d88d.msu"
            ssuUrl =           "$msDPath/2021/04/windows8.1-kb5001403-x86_c59ac03777801436fa01dbf341f164a709ce8f8a.msu"
        }
    }
    '8.1_64-bit' {
        $installHash = @{
            ssu =              'KB5001403'
            patchKBs =         $8PatchKbs
            patchUrl =         "$msCPath/2021/07/windows8.1-kb5004958-x64_8b73440b9c53bcea2660d9409b6ad3920f104cd2.msu"
            ssuUrl =           "$msDPath/2021/04/windows8.1-kb5001403-x64_7f15c4b281f38d43475abb785a32dbaf0355bad5.msu"
        }
    }
    '2012r2' {
        $installHash = @{
            ssu =              'KB5001403'
            patchKBs =         $8PatchKbs
            patchUrl =         "$msCPath/2021/07/windows8.1-kb5004958-x64_8b73440b9c53bcea2660d9409b6ad3920f104cd2.msu"
            ssuUrl =           "$msDPath/2021/04/windows8.1-kb5001403-x64_7f15c4b281f38d43475abb785a32dbaf0355bad5.msu"
        }
    }
    '2012' {
        $installHash = @{
            ssu =              'KB5001401'
            patchUrl =         "$msDPath/2021/07/windows8-rt-kb5004960-x64_15b7362a1146198852b2be37c4997f81e16495b6.msu"
            ssuUrl =           "$msDPath/2021/04/windows8-rt-kb5001401-x64_1027ae2c9888c2dfe0caadeafc506b3012789c56.msu"
            patchKBs = @(
                'KB5004960'
            )
        }

    }
    # 1507-1809 KBs specify they're for Win10 LTSB, so they might be unlikely to install... Not sure how to check at the moment.. related to the ESU question..
    '1507_32-bit' {
        $installHash = @{
            ssu =              'KB5001399'
            patchKBs =         $1507PatchKbs
            patchUrl =         "$msDPath/2021/08/windows10.0-kb5005040-x86_b6cbcefdb22b22a3a8841420d32af34d633a5c7d.msu"
            ssuUrl =           "$msDPath/2021/04/windows10.0-kb5001399-x64_d33c5bf98f9c323bdfd3d7103a5215cb874221a1.msu"
        }
    }
    '1507_64-bit' {
        $installHash = @{
            ssu =              'KB5001399'
            patchKBs =         $1507PatchKbs
            patchUrl =         "$msCPath/2021/08/windows10.0-kb5005040-x64_c9bb0618b0e9b1a50151e38796cd954923d0e202.msu"
            ssuUrl =           "$msDPath/2021/04/windows10.0-kb5001399-x86_e3fe821338f8dcc5b9abc712ce940f34b6ce4f9e.msu"
        }
    }
    '1607_32-bit' {
        $installHash = @{
            ssu =              'KB5001402'
            patchKBs =         $1607PatchKbs
            patchUrl =         "$msDPath/2021/08/windows10.0-kb5005043-x86_7e72b64b264e89ec87cf35af180b43c879b3ef5b.msu"
            ssuUrl =           "$msDPath/2021/04/windows10.0-kb5001402-x86_27a769112966bdc171f5f300bfd4819f02941f5a.msu"
        }
    }
    '1607_64-bit' {
        $installHash = @{
            ssu =              'KB5001402'
            patchKBs =         $1607PatchKbs
            patchUrl =         "$msCPath/2021/08/windows10.0-kb5005043-x64_6e39252b88646ca55582da59e6f86a021d8b6ddd.msu"
            ssuUrl =           "$msDPath/2021/04/windows10.0-kb5001402-x64_0108fcc32c0594f8578c3787babb7d84e6363864.msu"
        }
    }
    '2016' {
        $installHash = @{
            ssu =              'KB5001402'
            patchKBs =         $1607PatchKbs
            patchUrl =         "$msCPath/2021/08/windows10.0-kb5005043-x64_6e39252b88646ca55582da59e6f86a021d8b6ddd.msu"
            ssuUrl =           "$msDPath/2021/04/windows10.0-kb5001402-x64_0108fcc32c0594f8578c3787babb7d84e6363864.msu"
        }
    }
    '1809_32-bit' {
        $installHash = @{
            ssu =              'KB5005112'
            patchKBs =         $1809PatchKbs
            patchUrl =         "$msCPath/2021/08/windows10.0-kb5005030-x86_493fae3f27c82ab210f8bd408e89bc07aea5f5de.msu"
            ssuUrl =           "$msCPath/2021/08/windows10.0-kb5005112-x86_9c52dee3181a27bdc2a3f7dbbc8391c081c6871d.msu"
        }
    }
    '1809_64-bit' {
        $installHash = @{
            ssu =              'KB5005112'
            patchKBs =         $1809PatchKbs
            patchUrl =         "$msCPath/2021/08/windows10.0-kb5005030-x64_222160abfb75f543a693ca773dbcd0553ace6f03.msu"
            ssuUrl =           "$msDPath/2021/08/windows10.0-kb5005112-x64_81d09dc6978520e1a6d44b3b15567667f83eba2c.msu"
        }
    }
    '2019' {
        $installHash = @{
            ssu =              'KB5005112'
            patchKBs =         $1809PatchKbs
            patchUrl =         "$msCPath/2021/08/windows10.0-kb5005030-x64_222160abfb75f543a693ca773dbcd0553ace6f03.msu"
            ssuUrl =           "$msDPath/2021/08/windows10.0-kb5005112-x64_81d09dc6978520e1a6d44b3b15567667f83eba2c.msu"
        }
    }
    '1909_32-bit' {
        $installHash = @{
            ssu =              'KB5005412'
            patchKBs =         $1909PatchKbs
            patchUrl =         "$msCPath/2021/08/windows10.0-kb5005031-x86_38c48394e2f3c067febbdd0219d37d38545715d8.msu"
            ssuUrl =           "$msCPath/2021/08/windows10.0-kb5005412-x86_98f99f0aee4af93a076e5beeb72bf979c4b41f64.msu"
        }
    }
    '1909_64-bit' {
        $installHash = @{
            ssu =              'KB5005412'
            patchKBs =         $1909PatchKbs
            patchUrl =         "$msCPath/2021/08/windows10.0-kb5005031-x64_82d8a430666e65347948420466a0bcfd6c28e344.msu"
            ssuUrl =           "$msCPath/2021/08/windows10.0-kb5005412-x64_228ca7ad27c8f60174513607839c07686490e1e4.msu"
        }
    }
    '2004_32-bit' {
        $installHash = @{
            ssu =              $2004AndNewerSsuKb
            patchKBs =         $2004AndNewerPatchKbs
            patchUrl =         "$msDPath/2021/08/windows10.0-kb5005033-x86_d5b969d54b3155cca9ad2e36565e1d8603aab21a.msu"
            ssuUrl =           "$msDPath/2021/01/windows10.0-kb4598481-x86_32286dd2d08021ce7ce35ee4855beb81c8d5f09e.msu"
        }
    }
    '2004_64-bit' {
        $installHash = @{
            ssu =              $2004AndNewerSsuKb
            patchKBs =         $2004AndNewerPatchKbs
            patchUrl =         "$msDPath/2021/08/windows10.0-kb5005033-x64_ebab415d7a65f0b33f93e9a30875d74baa8930a7.msu"
            ssuUrl =           "$msDPath/2021/01/windows10.0-kb4598481-x64_749fe79fd2e31b145de37c2f9ebf4f711d174dc2.msu"
        }
    }
    '20H2_32-bit' {
        $installHash = @{
            ssu =              $2004AndNewerSsuKb
            patchKBs =         $2004AndNewerPatchKbs
            patchUrl =         "$msDPath/2021/08/windows10.0-kb5005033-x86_d5b969d54b3155cca9ad2e36565e1d8603aab21a.msu"
            ssuUrl =           "$msDPath/2021/01/windows10.0-kb4598481-x86_32286dd2d08021ce7ce35ee4855beb81c8d5f09e.msu"
        }
    }
    '20H2_64-bit' {
        $installHash = @{
            ssu =              $2004AndNewerSsuKb
            patchKBs =         $2004AndNewerPatchKbs
            patchUrl =         "$msDPath/2021/08/windows10.0-kb5005033-x64_ebab415d7a65f0b33f93e9a30875d74baa8930a7.msu"
            ssuUrl =           "$msDPath/2021/01/windows10.0-kb4598481-x64_749fe79fd2e31b145de37c2f9ebf4f711d174dc2.msu"
        }
    }
    # 21H1 doesn't currently have an SSU
    '21H1_32-bit' {
        $installHash = @{
            ssu =              $Null
            patchKBs =         $2004AndNewerPatchKbs
            patchUrl =         "$msDPath/2021/08/windows10.0-kb5005033-x86_d5b969d54b3155cca9ad2e36565e1d8603aab21a.msu"
            ssuUrl =           $Null
        }
    }
    '21H1_64-bit' {
        $installHash = @{
            ssu =              $Null
            patchKBs =         $2004AndNewerPatchKbs
            patchUrl =         "$msDPath/2021/08/windows10.0-kb5005033-x64_ebab415d7a65f0b33f93e9a30875d74baa8930a7.msu"
            ssuUrl =           $Null
        }
    }
    Default {
        $installHash = @{
            patchKBs = @()
            patchUrl = $Null
            ssuUrl = $Null
            ssu = $Null
        }
    }
}

If ($os -and $installHash.patchKbs.length) {
    $installedPatches = $installHash.patchKBs | ForEach-Object { Get-Hotfix -Id $_ -EA 0 }

    If ($installedPatches) {
        Write-Output "!Success: PrintNightmare is patched"
    } Else {
        Write-Output '!Failed: Vulnerable - No Matching KB Found.'
    }
}
