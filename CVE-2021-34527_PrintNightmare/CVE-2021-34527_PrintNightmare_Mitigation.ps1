<#
    CVE-2021-34527 PrintNightmare Mitigation

    This script ADDS the mitigation for this vulnerability. There will be some legitimate reasons to temporily remove this restriction.
    ALSO: once Microsoft releases a patch for this vulnerability, this mitigation should probably be undone. THIS IS TEMPORARY.


    https://blog.truesec.com/2021/06/30/fix-for-printnightmare-cve-2021-1675-exploit-to-keep-your-print-servers-running-while-a-patch-is-not-available/

    While we still recommend that the print spooler service should be disabled on any system that does not need it, we also want to provide a temporary
    workaround to make the exploit ineffective, while allowing you to keep your print servers running, until a patch is available.

    The exploit works by dropping a DLL in a subdirectory under C:\Windows\System32\spool\drivers

    By restricting the ACLs on this directory (and subdirectories) we can prevent malicious DLLs to be introduced by the print spooler service.

    At the moment, we are not aware of any way to force the DLL to be dropped in a different location.

    This will add a Deny rule for the print drivers directory and all subdirectories, preventing the SYSTEM account from modifying its contents.

    If administrators need to perform configuration changes that require the service to write in these directories, this rule can temporarily be removed,
    and re-added after the change via CVE-2021-34527_PrintNightmare_Mitigation_Removal.ps1
#>

$Path = "C:\Windows\System32\spool\drivers"
$BadEventId = 316
[array]$output

# Needs testing. Throws error in some cases. I think just in powershell 7? Alternative would be `$Acl = Get-Acl $Path`
$Acl = (Get-Item $Path).GetAccessControl('Access')

$Ar = New-Object  System.Security.AccessControl.FileSystemAccessRule("System", "Modify", "ContainerInherit, ObjectInherit", "None", "Deny")

$Acl.AddAccessRule($Ar)

Set-Acl $Path $Acl

$Acl = ((Get-Item $Path).GetAccessControl('Access')).Access | Where-Object { $_.IdentityReference -eq 'NT AUTHORITY\SYSTEM' -and $_.AccessControlType -eq 'Deny' }

If ($Acl) {
    [array]$output += "SYSTEM permissions were successfully set to DENY on the driver folders for the spooler service."
} Else {
    [array]$output += "There was a problem restricting permission on the spooler driver folder. Output: $Error"
    $status = 'Failed'
}

<#
    Ensures event log "Microsoft-Windows-PrintService/Operational" is enabled and checks for eventID 316
    on the "C:\Windows\System32\spool\drivers" directory and its contents, which is the most reliable way
    (at the moment) to check for attempts or success at this exploit
#>

Try {
    # Enable logging (disabled by default)
    $logDeets = Get-LogProperties 'Microsoft-Windows-PrintService/Operational'
    $logDeets.Enabled = $true
    Set-LogProperties -LogDetails $logDeets
} Catch {
    [array]$output += "There was a problem when attempting to enable the Microsoft-Windows-PrintService/Operational log"
    $status = 'Failed'
}

$logCheck =  Get-WinEvent 'Microsoft-Windows-PrintService/Operational' -EA 0
If ($logCheck) {
    $result = Get-WinEvent 'Microsoft-Windows-PrintService/Operational' | Where-Object { $_.Id -eq $BadEventId }

    If ($result) {
        [array]$output = "EventId 316 has been detected. This may be an indicator of attempted or successful exploit by CVE-2021-34527_PrintNightmare " + "`n" + $output
        [array]$output += "Output of detected event ID 316: $($result.Message)"
        $status = 'Failed'
    } Else {
        [array]$output += "EventId 316 has NOT been detected, this machine has not been exploited."
    }
} Else {
    [array]$output += "The Microsoft-Windows-PrintService/Operational log has no events to report!"
}

[array]$output += "Full error output: $Error"

$output = $output -join "`n"

If ($status) {
    $output = "!FAILED: $output"
} Else {
    $output = "!SUCCESS: $output"
}

Write-Output "$output"
