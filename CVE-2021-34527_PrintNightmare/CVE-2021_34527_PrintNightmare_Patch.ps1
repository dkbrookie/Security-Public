If ((Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters' -Name 'FullSecureChannelProtection' -EA 0)) {
    'Secured - Detected Updates '+$($KBResult) | Out-String
} Else {
    'Vulnerable - No Matching KB Found. Starting remediation...'
    ## Set simple names for OS' since things like R2 versions are complicated to parse out in swich statements
    $osName = (Get-WmiObject win32_operatingsystem).Caption
    If ($osName -like 'Microsoft Windows Server 2008 R2*') {
        $os = '2008r2'
    } ElseIf ($osName -like 'Microsoft Windows Server 2012*' -and $osName -notlike '*R2*') {
        $os = '2012'
    } ElseIf ($osName -like 'Microsoft Windows Server 2012 R2*') {
        $os = '2012R2'
    } ElseIf ($osName -like 'Microsoft Windows Server 2016*') {
        $os = '2016'
    } ElseIf ($osName -like 'Microsoft Windows Server 2019*') {
        $os = '2019'
    } Else {
        $os = 'Unsupported'
        Break
    }

    ## Set list of KBs required per OS
    Switch ($os) {
        '2008r2' { [array]$kbs = 4571719,4571729,4577051,4577053 }
        '2012' { [array]$kbs = 4571702,4571736,4577038,4577048 }
        '2012r2' { [array]$kbs = 4571703,4571723,4577066,4577071 }
        '2016' { [array]$kbs = 4571694,4577015 }
        '2019' { [array]$kbs = 4565349,4570333,4571748,4577069 }
    }

    $patchDir = "$env:windir\LTSvc\Patching"
    If (!(Test-Path -Path $patchDir -PathType Container)) {
        New-Item $patchDir -ItemType Directory | Out-Null
    }
    $installedKBs = ((Get-HotFix).HotFixID) -replace ('KB','')
    ForEach ($kb in $kbs) {
        If (!($installedKBs.Contains($kb))) {
            Write-Output "Detected KB$($kb) is missing. Downloading/installing KB$($kb)."
            Switch ($kb) {
                4571719 { $url = 'http://download.windowsupdate.com/c/msdownload/update/software/secu/2020/08/windows6.1-kb4571719-x64_5288d4c665b6d47f6fa9ff221b4b75a81a907ff1.msu' }
                4571729 { $url = 'http://download.windowsupdate.com/d/msdownload/update/software/secu/2020/08/windows6.1-kb4571729-x64_62b8672a50cebb4bfcd4fb16e18a39ab472a5269.msu' }
                4577051 { $url = 'http://download.windowsupdate.com/d/msdownload/update/software/secu/2020/09/windows6.1-kb4577051-x64_32dd00ed768fd9ef079335e2bb56101af13447c4.msu' }
                4577053 { $url = 'http://download.windowsupdate.com/d/msdownload/update/software/secu/2020/09/windows6.1-kb4577053-x64_81540c22784dcd768d027b2577884d8157199da8.msu' }
                4571702 { $url = 'http://download.windowsupdate.com/d/msdownload/update/software/secu/2020/08/windows8-rt-kb4571702-x64_31d0c26c78ed003e20c197b9f35869069f5f4b56.msu' }
                4571736 { $url = 'http://download.windowsupdate.com/d/msdownload/update/software/secu/2020/08/windows8-rt-kb4571736-x64_21c1f2e6aa5242f7de50803628b52b89a21285d3.msu' }
                4577038 { $url = 'http://download.windowsupdate.com/d/msdownload/update/software/secu/2020/09/windows8-rt-kb4577038-x64_4a3fff78e4b1ff22d6abfb6be812489ff6a39858.msu' }
                4577048 { $url = 'http://download.windowsupdate.com/d/msdownload/update/software/secu/2020/09/windows8-rt-kb4577048-x64_74cc8ac1942a664d0a39afd72c93763bccdeeb54.msu' }
                4571703 { $url = 'http://download.windowsupdate.com/c/msdownload/update/software/secu/2020/08/windows8.1-kb4571703-x64_a79ea590ca590b15fdd4a82579b27dd77024a357.msu' }
                4571723 { $url = 'http://download.windowsupdate.com/c/msdownload/update/software/secu/2020/08/windows8.1-kb4571723-x64_5f366bc88992b43b074421fd9b817c543c93e456.msu' }
                4577066 { $url = 'http://download.windowsupdate.com/d/msdownload/update/software/secu/2020/09/windows8.1-kb4577066-x64_640bbb7de82c25f72f14272d61bd6f9a52a3840f.msu' }
                4577071 { $url = 'http://download.windowsupdate.com/d/msdownload/update/software/secu/2020/09/windows8.1-kb4577071-x64_df414a69e87626a18e3070b8b5c9bb2b00070678.msu' }
                4571694 { $url = 'http://download.windowsupdate.com/d/msdownload/update/software/secu/2020/08/windows10.0-kb4571694-x64_220af1e3a18ef36cb4abe3d34a3ce15ce656753b.msu' }
                4577015 { $url = 'http://download.windowsupdate.com/d/msdownload/update/software/secu/2020/09/windows10.0-kb4577015-x64_0e838646b432d7b5360fffd0f12365ca181d475d.msu' }
                4565349 { $url = 'http://download.windowsupdate.com/d/msdownload/update/software/secu/2020/08/windows10.0-kb4565349-x64_919b9f31d4ccfa91183fbb9bab8c2975529e66b6.msu' }
                4570333 { $url = 'http://download.windowsupdate.com/d/msdownload/update/software/secu/2020/09/windows10.0-kb4570333-x64_8c3c376b98addc84ef5c6c59de3b59cb33436fee.msu' }
                4571748 { $url = 'http://download.windowsupdate.com/d/msdownload/update/software/updt/2020/08/windows10.0-kb4571748-x64_7b1aa70adab40508049098baff4da1eae5de5c63.msu' }
                4577069 { $url = 'http://download.windowsupdate.com/d/msdownload/update/software/updt/2020/09/windows10.0-kb4577069-x64_ea0fa6bd418d0684a7a077cb62384ae593d43b7a.msu' }
            }
            Write-Output "Downloading KB$($kb)..."
            (New-Object System.Net.WebClient).DownloadFile($url,"$patchDir\$kb.msu")
            Write-Output "Installing KB$($kb)..."
            Start-Process -FilePath wusa.exe -ArgumentList """$patchDir\$kb.msu"" /quiet /norestart /log:""$patchDir\$($kb)-InstallLog.evt""" -Wait
            Write-Output "KB$($kb) installation complete."
        }
    }

    ## Clean up downloaded patches since a lot of these are pretty big
    Remove-Item -Path "$patchDir\*.msu" -Force
}