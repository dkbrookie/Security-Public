# Log4j2 scan, detect, mitigate readme
## Introduction
A script is running on all Windows based machines that runs a scanner utility named "Yara" to determine if the machine has been compromised by the Log4j2 vulnerability. In addition to checking for compromise, the script applies a mitigation to prevent further or first time exploitation of the vulnerability. Please follow the guide below to understand the script, and how to utilize the logs in the case of a possible exploit detection.


## A ticket was generated, how do I investigate the reported possible exploit?
A ticket is generated when Yara reports back that it found suspicious logs that may indicate the Log4j2 vulnerability has been exploited on that local machine. Some information will be output into the ticket, but you can also get full detailed logs from `%windir%\LTSvc\utilities\yara\` on the machine that reported the possible exploit to do a deep dive and determine if further actions are needed.


## I want to scan the machine again, how do I do it?
Run this in CMD as Admin on the machine

`"C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -Command "& { [Net.ServicePointManager]::SecurityProtocol = [Enum]::ToObject([Net.SecurityProtocolType], 3072); (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/dkbrookie/Security-Public/main/CVE-2021-44228_Log4j2/log4j_Scan_Detect_Mitigate.ps1') | iex; Test-log4jVulnerability -scanScope 2 -mitigationAction Mitigate -forceScan $true }"`


## Change the actions of the script
Notice in the CMD line above there are parameters for `-scanScope`, `-mitigationAction`, and `-forceScan`. All of these are parameters and changing the value after the parameter will alter the actions of the script. For example, you can set `-mitigationAction` to `Reverse`, or `-forceScan` to `$false`.


## What is the mitigation doing?
If effected Java based applications are detected to be installed, the script applies a mitigation which prevents the exploit. On a more technical level, the mitigation is changing the value of what’s called a “Global Variable”, specifically `LOG4J_FORMAT_MSG_NO_LOOKUPS` to `TRUE`. In short, this disables message lookups globally and inoculates the vulnerability—which means it turns off the feature that allows the exploit. The `LOG4J_FORMAT_MSG_NO_LOOKUPS` feature enables certain special strings to be replaced at the time of logging by other dynamically-generated strings. So imagine in a username field the attacker instead submits a string of malicious code, the logging mechanism submits this into the log, and this code can execute. This is a gross oversimplification but captures the essence.


## Error output in script?
This is expected. The scan is attempting to scan all files which will include several protectred system files that can't be scanned. This means you're going to see some permission errors but they can be ignored.


## Script Functionality
•Script checks for previous successful scan and mitigation, if mitigated and already scanned, does not perform scan again unless `-forceScan` is set to `$true`

•Script checks the mitigation status and performs the action specified in `-mitigationAction`

•Script downloads yara utility to local machine, then scans the machine with yara looking specifically for logs that would indicate the machine has been exploited via the log4j2 vulnerability. Yara is ran in low CPU utilization mode by determining total threads of the CPU and using a max of half of them.

•If exploitation evidence is found in the logs, a ticket is created to the critical security board for review

•If the mitigation failed to apply a critical ticket is created to the critical security board for review
